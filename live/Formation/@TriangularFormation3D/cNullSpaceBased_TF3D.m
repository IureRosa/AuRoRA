%% Calculate kinematic control velocity

function cNullSpaceBased_TF3D(obj,priority)
% Direct transformation  X --> Q
obj.mDirTrans_TF3D;                   % get formation variables

% Formation pose error
obj.mFormationError_TF3D;

% Robot 1
x1 = obj.pPos.X(1);
y1 = obj.pPos.X(2);
z1 = obj.pPos.X(3);

% Robot 2
x2 = obj.pPos.X(4);
y2 = obj.pPos.X(5);
z2 = obj.pPos.X(6);

% Robot 3
x3 = obj.pPos.X(7);
y3 = obj.pPos.X(8);
z3 = obj.pPos.X(9);

%% Direct Jacobian Matrix (do not change it)

% begin
J = [                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    1/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         1/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         1/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    1/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         1/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         1/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    1/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         1/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         1/3;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (x1 - x2)/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (y1 - y2)/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (z1 - z2)/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -(x1 - x2)/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -(y1 - y2)/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -(z1 - z2)/((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (x1 - x3)/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (y1 - y3)/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (z1 - z3)/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -(x1 - x3)/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -(y1 - y3)/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -(z1 - z3)/((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2);
 ((2*x2 - 4*x1 + 2*x3)/(2*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) + ((2*x1 - 2*x2)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(3/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) + ((2*x1 - 2*x3)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(3/2)))/(1 - ((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2)^2/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)))^(1/2), ((2*y2 - 4*y1 + 2*y3)/(2*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) + ((2*y1 - 2*y2)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(3/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) + ((2*y1 - 2*y3)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(3/2)))/(1 - ((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2)^2/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)))^(1/2), ((2*z2 - 4*z1 + 2*z3)/(2*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) + ((2*z1 - 2*z2)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(3/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) + ((2*z1 - 2*z3)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(3/2)))/(1 - ((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2)^2/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)))^(1/2), ((2*x1 - 2*x3)/(2*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) - ((2*x1 - 2*x2)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(3/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)))/(1 - ((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2)^2/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)))^(1/2), ((2*y1 - 2*y3)/(2*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) - ((2*y1 - 2*y2)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(3/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)))/(1 - ((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2)^2/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)))^(1/2), ((2*z1 - 2*z3)/(2*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) - ((2*z1 - 2*z2)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(3/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)))/(1 - ((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2)^2/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)))^(1/2), ((2*x1 - 2*x2)/(2*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) - ((2*x1 - 2*x3)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(3/2)))/(1 - ((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2)^2/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)))^(1/2), ((2*y1 - 2*y2)/(2*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) - ((2*y1 - 2*y3)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(3/2)))/(1 - ((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2)^2/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)))^(1/2), ((2*z1 - 2*z2)/(2*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(1/2)) - ((2*z1 - 2*z3)*((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2))/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)^(1/2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)^(3/2)))/(1 - ((x1 - x2)^2 + (x1 - x3)^2 - (x2 - x3)^2 + (y1 - y2)^2 + (y1 - y3)^2 - (y2 - y3)^2 + (z1 - z2)^2 + (z1 - z3)^2 - (z2 - z3)^2)^2/(4*((x1 - x2)^2 + (y1 - y2)^2 + (z1 - z2)^2)*((x1 - x3)^2 + (y1 - y3)^2 + (z1 - z3)^2)))^(1/2);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (2*z2 - 4*z1 + 2*z3)/((y2 - 2*y1 + y3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -(2*y2 - 4*y1 + 2*y3)/((y2 - 2*y1 + y3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(z2 - 2*z1 + z3)/((y2 - 2*y1 + y3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (y2 - 2*y1 + y3)/((y2 - 2*y1 + y3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(z2 - 2*z1 + z3)/((y2 - 2*y1 + y3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (y2 - 2*y1 + y3)/((y2 - 2*y1 + y3)^2 + (z2 - 2*z1 + z3)^2);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -(2*z2 - 4*z1 + 2*z3)/((x2 - 2*x1 + x3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (2*x2 - 4*x1 + 2*x3)/((x2 - 2*x1 + x3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (z2 - 2*z1 + z3)/((x2 - 2*x1 + x3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(x2 - 2*x1 + x3)/((x2 - 2*x1 + x3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (z2 - 2*z1 + z3)/((x2 - 2*x1 + x3)^2 + (z2 - 2*z1 + z3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(x2 - 2*x1 + x3)/((x2 - 2*x1 + x3)^2 + (z2 - 2*z1 + z3)^2);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (2*y2 - 4*y1 + 2*y3)/((x2 - 2*x1 + x3)^2 + (y2 - 2*y1 + y3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -(2*x2 - 4*x1 + 2*x3)/((x2 - 2*x1 + x3)^2 + (y2 - 2*y1 + y3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(y2 - 2*y1 + y3)/((x2 - 2*x1 + x3)^2 + (y2 - 2*y1 + y3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (x2 - 2*x1 + x3)/((x2 - 2*x1 + x3)^2 + (y2 - 2*y1 + y3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(y2 - 2*y1 + y3)/((x2 - 2*x1 + x3)^2 + (y2 - 2*y1 + y3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (x2 - 2*x1 + x3)/((x2 - 2*x1 + x3)^2 + (y2 - 2*y1 + y3)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0]; 
% end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     

JP = J(1:3,:);
JS = J(4:6,:);
JO = J(7:9,:);

%% Controller

dQr = obj.pPos.dQd + obj.pPar.K1*tanh(obj.pPar.K2*obj.pPos.Qtil);
I = eye(9);

switch priority 

    case 'N'
        obj.pPos.dXr = pinv(J)*(dQr);

    case 'PSO'
        obj.pPos.dXr = pinv(JP)*dQr(1:3) + (I - pinv(JP)*JP)*(pinv(JS)*dQr(4:6) + (I - pinv(JS)*JS)*pinv(JO)*dQr(7:9));

    case 'SPO'
        obj.pPos.dXr = pinv(JS)*dQr(4:6) + (I - pinv(JS)*JS)*(pinv(JP)*dQr(1:3) + (I - pinv(JP)*JP)*pinv(JO)*dQr(7:9));

    case 'OSP'
        obj.pPos.dXr = pinv(JO)*dQr(7:9) + (I - pinv(JO)*JO)*(pinv(JS)*dQr(4:6) + (I - pinv(JS)*JS)*pinv(JP)*dQr(1:3));

    case 'S-PO'
        obj.pPos.dXr = pinv(JS)*dQr(4:6) + (I - pinv(JS)*JS)*(pinv([JP ; JO])*[dQr(1:3) ; dQr(7:9)]);

end

obj.pPos.Xr = obj.pPos.Xr + obj.pPos.dXr*obj.pPar.Ts;

end